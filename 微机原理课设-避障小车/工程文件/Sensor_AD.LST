C51 COMPILER V9.56.0.0   SENSOR_AD                                                         02/27/2023 16:10:31 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE SENSOR_AD
OBJECT MODULE PLACED IN Sensor_AD.OBJ
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.exe Sensor_AD.c DB OE BR LARGE INCDIR(E:\Study Soft\silicon\Inc;c:\SiLabs\MCU\I
                    -nc)

line level    source

   1          
   2          
   3          /*********************************************************************************************************
             -*
   4          **** 文件名：Sensor_AD.c
   5          **** 
   6          **** 文件描述：AD模块函数库
   7          ****               可用AD端口：ADC0 ----- P1.7    ADC1 ----- P2.0    ADC2 ----- P2.1    ADC3 ----- P2.2
   8          ****                                       ADC4 ----- P2.3        ADC5 ----- P2.4        ADC6 ----- P2.5        ADC7 ----- P2.6
   9          ****                                       ADC8 ----- P2.7        ADC9 ----- P3.0        
  10          ****              对应AD通道号是ADC0―――1...ADC9――10
  11          ****
  12          **** 创建人：FeiChen
  13          **** 
  14          **** 版本号：1.0
  15          **** 
  16          **** 修改记录：
  17          **** 
  18          **** 
  19          ****
  20          **********************************************************************************************************
             -*/
  21          
  22          //定义红外测距查表值
  23          code char IRData[256] = {       255,255,255,255,255,255,255,255,255,255,//第一组：10个
  24                                                                  200,200,200,200,200,150,150,150,150,150,//第二组：10个
  25                                                                  100,100,100,100,100, 90, 90, 90, 90, 90,//第三组：10个
  26                                                                   85, 85, 85, 80, 80, 80, 75, 75, 70, 70,//第四组：10个
  27                                                                   65, 60, 57, 55, 54, 51, 50, 48, 47, 46,//第五组：10个
  28                                                                   45, 43, 40, 39, 38, 37, 36, 36, 35, 35,//第六组：10个
  29                                                                   34, 34, 33, 33, 32, 32, 31, 31, 30, 30,//第七组：10个
  30                                                                   29, 29, 28, 28, 27, 27, 27, 26, 26, 26,//第八组：10个
  31                                                                   25, 25, 25, 24, 24, 24, 24, 23, 23, 23,//第九组：10个
  32                                                                   23, 22, 22, 22, 22, 21, 21, 21, 21, 20,//第十组：10个
  33                                                                   20, 20, 20, 20, 19, 19, 19, 19, 18, 18,//第11组：10个
  34                                                                   18, 18, 18, 17, 17, 17, 17, 17, 17, 16,//第12组：10个
  35                                                                   16, 16, 16, 16, 16, 16, 15, 15, 15, 15,//第13组：10个
  36                                                                   15, 15, 14, 14, 14, 14, 14, 14, 14, 14,//第14组：10个
  37                                                                   14, 13, 13, 13, 13, 13, 13, 13, 13, 13,//第15组：10个
  38                                                                   13, 12, 12, 12, 12, 12, 12, 12, 12, 12,//第16组：10个
  39                                                                   12, 12, 11, 11, 11, 11, 11, 11, 11, 11,//第17组：10个
  40                                                                   11, 11, 11, 11, 11, 10, 10, 10, 10, 10,//第18组：10个
  41                                                                   10, 10, 10, 10, 10, 10, 10, 10, 10, 10,//第19组：10个
  42                                                                   10,  9,  9,  9,  9,  9,  9,  9,  9,  9,//第20组：10个
  43                                                                    9,  9,  9,  9,  9,  9,  9,  9,  8,  8,//第21组：10个
  44                                                                    8,  8,  8,  8,  8,  8,  8,  8,  8,  8,//第22组：10个
  45                                                                    8,  8,  8,  8,  8,  8,  8,  7,  7,  7,//第23组：10个
  46                                                                    7,  7,  6,  6,  6,  6,  6,  6,  0,  0,//第24组：10个
  47                                                                    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,//第25组：10个
  48                                                                    0,  0,  0,  0,  0,  0,//第26组：6个                                                           
  49                                                                  };
  50          
  51          
  52          
C51 COMPILER V9.56.0.0   SENSOR_AD                                                         02/27/2023 16:10:31 PAGE 2   

  53          
  54          /*************************************************************
  55          //! 头文件
  56          **************************************************************/
  57          #include "Sensor_AD.h"
*** WARNING C318 IN LINE 5 OF Sensor_AD.h: can't open file 'General.h'
  58          
  59          #define AD_NUM  10              // 总共可选10路AD端口
  60          /*************************************************************************************************
  61          *****
  62          ***** 函数名：unsigned char GetIR_Distance(unsigned char channle)
  63          *****
  64          ***** 入口参数：channle：选择的第几路AD端口值，取值为1-10
  65          *****
  66          *****
  67          ***** 功能描述：获取红外传感器感测距离，先经过AD转换获取相应的电压值，然后将电压值经过距离函数转成
  68          *****                   障碍物的距离10――80cm                          
  69          *****              
  70          *****
  71          ***** 返回值：返回的就是红外测距距离值，取值范围0-255，但是10―80区间为有效红外测距距离值
  72          *****
  73          ***** 作者：FeiChen
  74          **************************************************************************************************/
  75          
  76          
  77          unsigned char GetIR_Distance(unsigned char channle)
  78          {
  79   1              xdata unsigned int ucIRDisValue = 0;
  80   1      
  81   1      
  82   1              //AD通道错误处理
  83   1              if(channle<0 || channle>10)
  84   1              {
  85   2                      return 0;
  86   2              }
  87   1              //获取AD转换值
  88   1              ucIRDisValue = ADC_DistanceGet(channle);
  89   1      
  90   1              //将AD转换值切换成距离值
  91   1              ucIRDisValue = ((int)SensorDistanceProcess(ucIRDisValue));
  92   1      
  93   1              //设置距离值不超过255
  94   1              if(ucIRDisValue>255)
  95   1              {
  96   2                      ucIRDisValue = 255;
  97   2              }
  98   1              return (char)ucIRDisValue;
  99   1              
 100   1      }
 101          
 102          
 103          /*************************************************************************************************
 104          *****
 105          ***** 函数名：unsigned int GetIRDistance(unsigned char channle)
 106          *****
 107          ***** 入口参数：channle：选择的第几路AD端口值，取值为1-10
 108          *****
 109          *****
 110          ***** 功能描述：获取对应通道号的AD采样值
 111          *****                                           
 112          *****              
 113          *****
C51 COMPILER V9.56.0.0   SENSOR_AD                                                         02/27/2023 16:10:31 PAGE 3   

 114          ***** 返回值：返回对应通道AD采样值，取值范围是0―1024
 115          *****
 116          ***** 作者：FeiChen
 117          **************************************************************************************************/
 118          unsigned int GetIRDistance(unsigned char channle)
 119          {
 120   1              xdata unsigned int ucIRDisValue = 0;
 121   1      
 122   1              if(channle<0 || channle>10)
 123   1              {
 124   2                      return 0;
 125   2              }
 126   1              ucIRDisValue = ADC_DistanceGet(channle);
 127   1      
 128   1              return ucIRDisValue;
 129   1      
 130   1      }
 131          
 132          /************************************************************
 133          //! 函数名：void ADC_PortInit()
 134          //! 函数说明：ADC引脚初始化
 135          //!----------------------------------------------------------
 136          //! 引脚图：
 137          //!----------------------------------------------------------
 138          //!     引脚             端口              AMX0P
 139          //!
 140          //!     AD0--------------P1.7--------------0x07
 141          //!     AD1--------------P2.0--------------0x08
 142          //!     AD2--------------P2.1--------------0x09
 143          //!     AD3--------------P2.2--------------0x0A
 144          //!     AD4--------------P2.3--------------0x0B
 145          //!     AD5--------------P2.4--------------0x0C
 146          //!     AD6--------------P2.5--------------0x0D
 147          //!     AD7--------------P2.6--------------0x0E
 148          //!     AD8--------------P2.7--------------0x0F
 149          //!     AD9--------------P3.0--------------0x10
 150          //!
 151          *************************************************************************************************
 152          *****
 153          ***** 函数名：void ADC_Init()
 154          ***** 入口参数：无
 155          *****
 156          *****
 157          ***** 功能描述：ADC初始化
 158          *****                                           
 159          *****              
 160          *****
 161          ***** 返回值：无
 162          *****
 163          ***** 作者：FeiChen
 164          **************************************************************************************************/
 165          
 166          void ADC_Init()
 167          {
 168   1              unsigned char SFRPAGE_save = SFRPAGE;
 169   1      
 170   1              SFRPAGE = CONFIG_PAGE;
 171   1              
 172   1              ADC0CN  = 0xC0;                        //跟踪模式，开启转换
 173   1      
 174   1              ADC0CF = (SYSCLOCK/3000000 - 1) << 3;
 175   1              ADC0CF &= ~0x04;                       //右端对齐
C51 COMPILER V9.56.0.0   SENSOR_AD                                                         02/27/2023 16:10:31 PAGE 4   

 176   1      
 177   1              EIE1 &= ~0x08;                         //禁止ADC中断
 178   1      
 179   1              //AD0EN = 1;
 180   1      
 181   1              REF0CN = 0x08;                          //VDD为参考电压，温度传感器关闭，偏压和电压基准关
 182   1      
 183   1              SFRPAGE = SFRPAGE_save;
 184   1      
 185   1      }
 186          /*************************************************************************************************
 187          *****
 188          ***** 函数名：unsigned int ADC_DistanceGet(unsigned char AD_port)
 189          *****
 190          ***** 入口参数：AD_port：选择的第几路AD端口值，取值为1-10
 191          *****
 192          *****
 193          ***** 功能描述：获取对应通道号的AD采样值
 194          *****                                           
 195          *****              
 196          *****
 197          ***** 返回值：返回对应通道AD采样值，取值范围是0―1024
 198          *****
 199          ***** 作者：FeiChen
 200          **************************************************************************************************/
 201          
 202          unsigned int ADC_DistanceGet(unsigned char AD_port)
 203          {
 204   1              
 205   1              xdata unsigned char AD_counter=0;
 206   1              xdata unsigned char i = 0;
 207   1              xdata unsigned char adc0_h,adc0_l;
 208   1              xdata unsigned int ad_test;
 209   1              //进行10次AD采样，将对应的AD值保存在数组中
 210   1              xdata unsigned int ADC_DataStore[10] = {0,0,0,0,0,0,0,0,0,0};
 211   1      
 212   1              //AD端口错误处理，只操作1-10号AD端口
 213   1              if(AD_port>0x0A)
 214   1              {
 215   2                      return 0xFF;
 216   2              }
 217   1      
 218   1              //选中对应的AD端口进行AD采样    
 219   1              AD_PortSelection(AD_port);
 220   1              
 221   1              //开始进行AD转换
 222   1              ADC_ConvertStart();
 223   1              //进行10次AD采样，将10位采样数据存放在数组中
 224   1              for(AD_counter=0;AD_counter<10;AD_counter++)
 225   1              {
 226   2                      while(!AD0INT);
 227   2      
 228   2                      adc0_h = ADC0H;
 229   2                      adc0_h &= 0x03;//提取AD采用高两位数据
 230   2                      adc0_l = ADC0L;//提取AD采用低八位数据
 231   2                      
 232   2              ADC_DataStore[AD_counter] = ((unsigned int)(adc0_h)<<8) + (unsigned int)adc0_l;
 233   2                      //ADC_DataStore[AD_counter] = (unsigned int)(adc0_l);
 234   2                      
 235   2                      AD0INT = 0;     //清ADC0中断标志
 236   2      
 237   2                      ADC_ConvertStart();
C51 COMPILER V9.56.0.0   SENSOR_AD                                                         02/27/2023 16:10:31 PAGE 5   

 238   2                      
 239   2                      i++;                    
 240   2              }
 241   1                      //ADC_FlagClear();
 242   1      
 243   1      
 244   1          //ADC_DataStore[0] = ADC_AvrDataGet(ADC_DataStore);
 245   1              //return SensorData[AD_port][0];
 246   1              ad_test = ADC_AvrDataGet(ADC_DataStore);//获取10次采样的平均值作为当前AD值
 247   1              //ad_test++;
 248   1              //return (ADC_AvrDataGet(ADC_DataStore));
 249   1              return(ad_test);
 250   1      }
 251          /*************************************************************************************************
 252          *****
 253          ***** 函数名：void ADC_ConvertStart()
 254          *****
 255          ***** 入口参数：
 256          *****
 257          *****
 258          ***** 功能描述：AD转换启动函数，AD转换使能开始。
 259          *****                                           
 260          *****              
 261          *****
 262          ***** 返回值：
 263          *****
 264          ***** 作者：FeiChen
 265          **************************************************************************************************/
 266          
 267          void ADC_ConvertStart()
 268          {
 269   1              unsigned char SFRPAGE_save = SFRPAGE;
 270   1      
 271   1              SFRPAGE = CONFIG_PAGE;
 272   1      
 273   1              AD0EN = 1;              //AD转换使能
 274   1      
 275   1              //EA = 0;
 276   1      
 277   1              AD0INT = 0;             //清楚ADC0中断标志
 278   1      
 279   1      
 280   1              AD0BUSY = 1;    //启动ADC0转换
 281   1      
 282   1              SFRPAGE = SFRPAGE_save;
 283   1      }
 284          
 285          /*************************************************************************************************
 286          *****
 287          ***** 函数名：void AD_PortSelection(AD_port)
 288          *****
 289          ***** 入口参数：port_unm――对应需要选择的AD端口号，取值范围是1--10端口
 290          *****
 291          *****
 292          ***** 功能描述：AD转换端口配置函数，选中对应通道进行AD输入
 293          *****                                           
 294          *****              
 295          *****
 296          ***** 返回值：无
 297          *****
 298          ***** 作者：FeiChen
 299          **************************************************************************************************/
C51 COMPILER V9.56.0.0   SENSOR_AD                                                         02/27/2023 16:10:31 PAGE 6   

 300          
 301          void AD_PortSelection(unsigned char port_unm)
 302          {
 303   1              unsigned char SFRPAGE_save = SFRPAGE;
 304   1      
 305   1              SFRPAGE = CONFIG_PAGE;
 306   1              
 307   1              //1-10号AD端口选择，配置为输入
 308   1              switch(port_unm)
 309   1              {
 310   2                      case 0x01: AMX0P = 0x07; break;
 311   2                      case 0x02: AMX0P = 0x08; break;
 312   2                      case 0x03: AMX0P = 0x09; break;
 313   2                      case 0x04: AMX0P = 0x0A; break;
 314   2                      case 0x05: AMX0P = 0x0B; break;
 315   2                      case 0x06: AMX0P = 0x0C; break;
 316   2                      case 0x07: AMX0P = 0x0D; break;
 317   2                      case 0x08: AMX0P = 0x0E; break;
 318   2                      case 0x09: AMX0P = 0x0F; break;
 319   2                      case 0x0A: AMX0P = 0x10; break;
 320   2      
 321   2                      default: break;
 322   2      
 323   2              }       
 324   1      
 325   1              AMX0N = 0x1F; //负输入端选择VDD
 326   1      
 327   1      
 328   1              SFRPAGE = SFRPAGE_save;
 329   1      
 330   1      }
 331          /*************************************************************************************************
 332          *****
 333          ***** 函数名：unsigned int ADC_AvrDataGet(unsigned int *AD_data)
 334          *****
 335          ***** 入口参数：unsigned int *AD_data――对应的是已保存的AD采样值
 336          *****
 337          *****
 338          ***** 功能描述：获取平均值
 339          *****                   AD值处理函数，将10次采集到的AD值进行排序，选取序号为3、4、5的值进行平均值返回
 340          *****                                           
 341          *****              
 342          *****
 343          ***** 返回值：返回处理后的平均值
 344          *****
 345          ***** 作者：FeiChen
 346          **************************************************************************************************/
 347          
 348          unsigned int ADC_AvrDataGet(unsigned int *AD_data)
 349          {
 350   1              xdata unsigned int ucAD_avragy,k;
 351   1              xdata unsigned int *uiAD_data = AD_data;
 352   1              xdata unsigned char i,j;
 353   1              xdata unsigned int AD_Array[10];
 354   1      
 355   1              //保存10次采样值
 356   1              for(i=0;i<10;i++)
 357   1              {
 358   2                      AD_Array[i] = AD_data[i];
 359   2              }
 360   1              //对10次采样值进行排序
 361   1              for(i=0;i<10;i++)
C51 COMPILER V9.56.0.0   SENSOR_AD                                                         02/27/2023 16:10:31 PAGE 7   

 362   1                      for(j=0;j<10-i;j++)
 363   1                      {
 364   2                              if(AD_Array[j]>AD_Array[j+1])
 365   2                              {
 366   3                                      k = AD_Array[j];
 367   3                                      AD_Array[j] = AD_Array[j+1];
 368   3                                      AD_Array[j+1] = k;
 369   3                              }
 370   2                      }
 371   1      
 372   1          //返回其中中间的三个数值平均值
 373   1              ucAD_avragy = AD_Array[3] + AD_Array[4] + AD_Array[5];
 374   1               
 375   1              return ucAD_avragy/3;
 376   1      
 377   1      }
 378          /*************************************************************
 379          //! 函数名：void ADC0_ISR (void) interrupt 10
 380          //! 函数说明：ADC中断函数
 381          *************************************************************/
 382          /*void ADC0_ISR (void) interrupt 10
 383          {
 384                  
 385           }*/
 386          
 387          
 388          /*************************************************************************************************
 389          *****
 390          ***** 函数名：double SensorDistanceProcess(double x )
 391          *****
 392          ***** 入口参数：double x――对应的是已经处理过的AD端口采样值
 393          *****
 394          *****
 395          ***** 功能描述：ADC值距离转换
 396          *****                   通过查询GP2D12曲线表，制作相应的距离和AD值的对应函数关系，进行转换
 397          *****                                           
 398          *****              
 399          *****
 400          ***** 返回值：返回经过距离转换后的距离值
 401          *****
 402          ***** 作者：FeiChen
 403          **************************************************************************************************/
 404          /*************************************************************
 405          //! 函数名：double SensorDistanceProcess(double x )
 406          //! 函数说明：ADC值距离转换
 407          *************************************************************/
 408          double SensorDistanceProcess(double x )
 409          {
 410   1      
 411   1              int IRIndex = 0;
 412   1              IRIndex = x/4;
 413   1              return IRData[IRIndex];
 414   1      
 415   1      /*
 416   1              xdata double result;
 417   1              static double final_result;
 418   1              result = pow(x, -1.320888871);
 419   1              final_result = result * 59599.430602019;
 420   1              return final_result;
 421   1      */
 422   1      
 423   1      }    
C51 COMPILER V9.56.0.0   SENSOR_AD                                                         02/27/2023 16:10:31 PAGE 8   

 424          /*************************************************************
 425          //! 文件结束
 426          *************************************************************/
 427          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    684    ----
   CONSTANT SIZE    =    276    ----
   XDATA SIZE       =   ----      58
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
